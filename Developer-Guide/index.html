<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Developer Guide - SQL DS Cache</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Developer Guide";
    var mkdocs_page_input_path = "Developer-Guide.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> SQL DS Cache</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../User-Guide/">Getting Started</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../OAP-Installation-Guide/">OAP Installation Guide</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Advanced-Configuration/">Advanced Configuration</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Developer Guide</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#building">Building</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#building-sql-index-and-data-source-cache">Building SQL Index and  Data Source Cache</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#running-tests">Running Tests</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#building-with-intel-optanetm-dc-persistent-memory-module">Building with Intel® Optane™ DC Persistent Memory Module</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#prerequisites-for-building-with-pmem-support">Prerequisites for building with PMem support</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#memkind-installation">memkind installation</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">SQL DS Cache</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Developer Guide</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="developer-guide">Developer Guide</h1>
<ul>
<li><a href="#Building">Building</a></li>
<li><a href="#integrating-with-spark">Integrating with Spark*</a></li>
<li><a href="#enabling-numa-binding-for-pmem-in-spark">Enabling NUMA binding for Intel® Optane™ DC Persistent Memory in Spark</a></li>
</ul>
<h2 id="building">Building</h2>
<h3 id="building-sql-index-and-data-source-cache">Building SQL Index and  Data Source Cache</h3>
<p>Building with <a href="http://maven.apache.org/">Apache Maven*</a>.</p>
<p>Clone the OAP project:</p>
<pre><code>git clone -b &lt;tag-version&gt;  https://github.com/Intel-bigdata/OAP.git
cd OAP
</code></pre>
<p>Build the <code>oap-cache</code> package:</p>
<pre><code>mvn clean -pl com.intel.oap:oap-cache -am package
</code></pre>
<h3 id="running-tests">Running Tests</h3>
<p>Run all the tests:</p>
<pre><code>mvn clean -pl com.intel.oap:oap-cache -am test
</code></pre>
<p>Run a specific test suite, for example <code>OapDDLSuite</code>:</p>
<pre><code>mvn -DwildcardSuites=org.apache.spark.sql.execution.datasources.oap.OapDDLSuite test
</code></pre>
<p><strong>NOTE</strong>: Log level of unit tests currently default to ERROR, please override oap-cache/oap/src/test/resources/log4j.properties if needed.</p>
<h3 id="building-with-intel-optanetm-dc-persistent-memory-module">Building with Intel® Optane™ DC Persistent Memory Module</h3>
<h4 id="prerequisites-for-building-with-pmem-support">Prerequisites for building with PMem support</h4>
<p>Install the required packages on the build system:</p>
<ul>
<li><a href="https://help.directadmin.com/item.php?id=494">cmake</a></li>
<li><a href="https://github.com/memkind/memkind/tree/v1.10.1-rc2">memkind</a></li>
<li><a href="https://github.com/pmem/vmemcache">vmemcache</a></li>
<li><a href="http://arrow.apache.org/blog/2017/08/08/plasma-in-memory-object-store/">Plasma</a></li>
</ul>
<h4 id="memkind-installation">memkind installation</h4>
<p>The memkind library depends on <code>libnuma</code> at the runtime, so it must already exist in the worker node system. Build the latest memkind lib from source:</p>
<pre><code>git clone -b v1.10.1-rc2 https://github.com/memkind/memkind
cd memkind
./autogen.sh
./configure
make
make install
   ``` 
#### vmemcache installation

To build vmemcache library from source, you can (for RPM-based linux as example):
</code></pre>
<p>git clone https://github.com/pmem/vmemcache
cd vmemcache
mkdir build
cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCPACK_GENERATOR=rpm
make package
sudo rpm -i libvmemcache*.rpm</p>
<pre><code>#### Plasma installation

To use optimized Plasma cache with OAP, you need following components:  

   (1) `libarrow.so`, `libplasma.so`, `libplasma_jni.so`: dynamic libraries, will be used in Plasma client.   
   (2) `plasma-store-server`: executable file, Plasma cache service.  
   (3) `arrow-plasma-0.17.0.jar`: will be used when compile oap and spark runtime also need it. 

- so file and binary file  
  Clone code from Intel-arrow repo and run following commands, this will install `libplasma.so`, `libarrow.so`, `libplasma_jni.so` and `plasma-store-server` to your system path(`/usr/lib64` by default). And if you are using Spark in a cluster environment, you can copy these files to all nodes in your cluster if the OS or distribution are same, otherwise, you need compile it on each node.

</code></pre>
<p>cd /tmp
git clone https://github.com/Intel-bigdata/arrow.git
cd arrow &amp;&amp; git checkout apache-arrow-0.17.0-intel-oap-0.9
cd cpp
mkdir release
cd release</p>
<h1 id="build-libarrow-libplasma-libplasma_java">build libarrow, libplasma, libplasma_java</h1>
<p>cmake -DCMAKE_INSTALL_PREFIX=/usr/ -DCMAKE_BUILD_TYPE=Release -DARROW_BUILD_TESTS=on -DARROW_PLASMA_JAVA_CLIENT=on -DARROW_PLASMA=on -DARROW_DEPENDENCY_SOURCE=BUNDLED  ..
make -j$(nproc)
sudo make install -j$(nproc)</p>
<pre><code>
- arrow-plasma-0.17.0.jar  
   arrow-plasma-0.17.0.jar is provided in maven central repo, you can download [it](https://repo1.maven.org/maven2/com/intel/arrow/arrow-plasma/0.17.0/arrow-plasma-0.17.0.jar) and copy to `$SPARK_HOME/jars` dir.
   Or you can manually install it, change to arrow repo java direction, run following command, this will install arrow jars to your local maven repo, and you can compile oap-cache module package now. Beisdes, you need copy arrow-plasma-0.17.0.jar to `$SPARK_HOME/jars/` dir, cause this jar is needed when using external cache.

</code></pre>
<p>cd $ARROW_REPO_DIR/java
mvn clean -q -pl plasma -DskipTests install</p>
<pre><code>

#### Building the package
You need to add `-Ppersistent-memory` to build with PMem support. For `noevict` cache strategy, you also need to build with `-Ppersistent-memory` parameter.
</code></pre>
<p>mvn clean -q -pl com.intel.oap:oap-cache -am  -Ppersistent-memory -DskipTests package</p>
<pre><code>For vmemcache cache strategy, please build with command:
</code></pre>
<p>mvn clean -q -pl com.intel.oap:oap-cache -am -Pvmemcache -DskipTests package</p>
<pre><code>Build with this command to use all of them:
</code></pre>
<p>mvn clean -q -pl com.intel.oap:oap-cache -am  -Ppersistent-memory -Pvmemcache -DskipTests package</p>
<pre><code>
## Integrating with Spark

Although SQL Index and Data Source Cache act as a plug-in JAR to Spark, there are still a few tricks to note when integrating with Spark. The OAP team explored using the Spark extension &amp; data source API to deliver its core functionality. However, the limits of the Spark extension and data source API meant that we had to make some changes to Spark internals. As a result you must check whether your installation is an unmodified Community Spark or a customized Spark.

### Integrating with Community Spark

If you are running a Community Spark, things will be much simpler. Refer to [User Guide](User-Guide.md) to configure and setup Spark to work with OAP.

### Integrate with Customized Spark

In this case check whether the OAP changes to Spark internals will conflict with or override your private changes. 

- If there are no conflicts or overrides, the steps are the same as the steps of unmodified version of Spark described above. 
- If there are conflicts or overrides, develop a merge plan of the source code to make sure the code changes you made in to the Spark source appear in the corresponding file included in OAP the project. Once merged, rebuild OAP.

The following files need to be checked/compared for changes:

</code></pre>
<p>•   org/apache/spark/sql/execution/DataSourceScanExec.scala <br />
        Add the metrics info to OapMetricsManager and schedule the task to read from the cached 
•   org/apache/spark/sql/execution/datasources/FileFormatDataWriter.scala
                Return the result of write task to driver.
•   org/apache/spark/sql/execution/datasources/FileFormatWriter.scala
        Add the result of write task. 
•   org/apache/spark/sql/execution/datasources/OutputWriter.scala<br />
        Add new API to support return the result of write task to driver.
•   org/apache/spark/status/api/v1/OneApplicationResource.scala  <br />
        Update the metric data to spark web UI.
•   org/apache/spark/sql/execution/datasources/parquet/VectorizedColumnReader.java
        Change the private access of variable to protected
•   org/apache/spark/sql/execution/datasources/parquet/VectorizedPlainValuesReader.java
        Change the private access of variable to protected
•   org/apache/spark/sql/execution/datasources/parquet/VectorizedRleValuesReader.java
        Change the private access of variable to protected
•   org/apache/spark/sql/execution/vectorized/OnHeapColumnVector.java
        Add the get and set method for the changed protected variable.</p>
<pre><code>
## Enabling NUMA binding for PMem in Spark

### Rebuilding Spark packages with NUMA binding patch 

When using PMem as a cache medium apply the [NUMA](https://www.kernel.org/doc/html/v4.18/vm/numa.html) binding patch [numa-binding-spark-3.0.0.patch](./numa-binding-spark-3.0.0.patch) to Spark source code for best performance.

1. Download src for [Spark-3.0.0](https://archive.apache.org/dist/spark/spark-3.0.0/spark-3.0.0.tgz) and clone the src from github.

2. Apply this patch and [rebuild](https://spark.apache.org/docs/latest/building-spark.html) the Spark package.

</code></pre>
<p>git apply  numa-binding-spark-3.0.0.patch</p>
<pre><code>
3. Add these configuration items to the Spark configuration file $SPARK_HOME/conf/spark-defaults.conf to enable NUMA binding.


</code></pre>
<p>spark.yarn.numa.enabled true 
```
<strong>NOTE</strong>: If you are using a customized Spark, you will need to manually resolve the conflicts.</p>
<h3 id="using-pre-built-patched-spark-packages">Using pre-built patched Spark packages</h3>
<p>If you think it is cumbersome to apply patches, we have a pre-built Spark <a href="https://github.com/Intel-bigdata/spark/releases/download/v3.0.0-intel-oap-0.9.0/spark-3.0.0-bin-hadoop2.7-intel-oap-0.9.0.tgz">spark-3.0.0-bin-hadoop2.7-intel-oap-0.9.0.tgz</a> with the patch applied.</p>
<h6 id="other-names-and-brands-may-be-claimed-as-the-property-of-others">*Other names and brands may be claimed as the property of others.</h6>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../Advanced-Configuration/" class="btn btn-neutral" title="Advanced Configuration"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Advanced-Configuration/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
